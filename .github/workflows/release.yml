name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag (must start with v), e.g. v0.1.0"
        required: true
        type: string

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
          - os: ubuntu-22.04
    runs-on: ${{ matrix.os }}
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.version || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate release tag
        run: |
          if [[ ! "${RELEASE_TAG}" =~ ^v.+ ]]; then
            echo "version must start with v, got: ${RELEASE_TAG}" >&2
            exit 1
          fi

      - name: Build archive
        run: scripts/release/build-archive.sh "${RELEASE_TAG}"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: |
            dist/release/*.tar.gz
            dist/release/*.sha256

  publish:
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.version || github.ref_name }}
      HOMEBREW_TAP_REPO: ${{ secrets.HOMEBREW_TAP_REPO }}
      HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/release
          merge-multiple: true

      - name: Compose checksums
        run: |
          cat dist/release/*.sha256 | sort -k2 > dist/release/checksums.txt

      - name: Generate Homebrew formula
        run: |
          scripts/release/generate-homebrew-formula.sh \
            --tag "${RELEASE_TAG}" \
            --repo "${GITHUB_REPOSITORY}" \
            --checksums dist/release/checksums.txt \
            --output dist/release/abc.rb

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          target_commitish: ${{ github.sha }}
          files: |
            dist/release/*.tar.gz
            dist/release/checksums.txt
            dist/release/abc.rb
          generate_release_notes: true

      - name: Publish formula to tap repo
        if: ${{ env.HOMEBREW_TAP_REPO != '' && env.HOMEBREW_TAP_TOKEN != '' }}
        env:
          VERSION: ${{ env.RELEASE_TAG }}
        run: |
          scripts/release/publish-formula-to-tap.sh \
            dist/release/abc.rb \
            "${HOMEBREW_TAP_REPO}" \
            "${HOMEBREW_TAP_TOKEN}" \
            "${VERSION#v}"
